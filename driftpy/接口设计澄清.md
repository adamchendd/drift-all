# 接口设计澄清：回答用户的两个问题

## 问题1：`get_data(pubkey)` 在 Rust SDK 中有这个方法吗？

### 答案：**没有**

**Rust SDK 的接口**：
- ✅ `OracleMap::get_by_market(market: &MarketId) -> Option<Oracle>`
- ❌ **没有** `get_data(pubkey)` 方法

**Rust SDK 的设计**：
- `OracleMap` 是专门用于 oracle 的类
- 只提供 `get_by_market(market: MarketId)` 接口
- `MarketId` 是一个枚举类型，可以区分 perp 和 spot 市场

**Python SDK 的 `get_data(pubkey)`**：
- 这是 `WebsocketMultiAccountSubscriber` 的**通用接口**
- 不仅用于 oracle，还用于其他账户类型（如 User 账户、Market 账户等）
- 这是 Python SDK 特有的，用于向后兼容非 oracle 账户

---

## 问题2：`get_data(oracle_id)` 中的 `oracle_id` 是什么？

### 答案：`oracle_id` 是字符串格式 `"pubkey-source_num"`，**不是索引数字**

### `oracle_id` 的定义

**Python SDK** (`oracle_id.py` L45-49):
```python
def get_oracle_id(public_key: Pubkey, source: OracleSource) -> str:
    """
    Returns the oracle id for a given oracle and source
    """
    return f"{str(public_key)}-{get_oracle_source_num(source)}"
```

**格式**：`"pubkey-source_num"`

**示例**：
- `PUMP-PERP` (PythLazer): `"5r8RWTaRiMgr9Lph3FTUE3sGb1vymhpCrm83Bovjfcps-1"`
- `1KPUMP-PERP` (PythLazer1K): `"5r8RWTaRiMgr9Lph3FTUE3sGb1vymhpCrm83Bovjfcps-2"`

### 为什么不会有歧义？

1. **包含完整的 pubkey**：`oracle_id` 包含完整的 Solana pubkey（44 个字符）
2. **包含 source_num**：区分不同的 oracle source（如 PythLazer vs PythLazer1K）
3. **字符串格式**：不是数字，不会与市场索引混淆

### Python SDK 的接口设计

**Oracle 专用接口**：
```python
# 使用 oracle_id（字符串）
def get_oracle_price_data_and_slot(self, oracle_id: str) -> Optional[DataAndSlot[OraclePriceData]]

# 使用市场索引（数字）
def get_oracle_price_data_and_slot_for_perp_market(self, market_index: int) -> Optional[DataAndSlot[OraclePriceData]]
def get_oracle_price_data_and_slot_for_spot_market(self, market_index: int) -> Optional[DataAndSlot[OraclePriceData]]
```

**关键点**：
- `get_oracle_price_data_and_slot(oracle_id: str)` - 接受 `oracle_id` 字符串
- `get_oracle_price_data_and_slot_for_perp_market(market_index: int)` - 接受 perp 市场索引
- `get_oracle_price_data_and_slot_for_spot_market(market_index: int)` - 接受 spot 市场索引
- **不会有歧义**，因为参数类型不同（`str` vs `int`）

---

## 修正后的接口设计

### 1. `WebsocketMultiAccountSubscriber.get_data`（通用接口）

**用途**：
- 非 oracle 账户（如 User 账户、Market 账户）
- 向后兼容

**签名**：
```python
def get_data(self, key: Union[Pubkey, str]) -> Optional[DataAndSlot]:
    """
    获取数据（通用接口）
    - 如果key是Pubkey：用于非oracle账户（向后兼容）
    - 如果key是str（oracle_id）：用于oracle账户（新方式）
    """
```

**说明**：
- 这是 Python SDK 的通用接口，Rust SDK 没有对应的方法
- 用于向后兼容非 oracle 账户

### 2. `WebsocketDriftClientAccountSubscriber.get_oracle_price_data_and_slot`（Oracle专用接口）

**用途**：
- Oracle 账户
- 类似 Rust SDK 的 `get_by_market(market: MarketId)`

**签名**：
```python
def get_oracle_price_data_and_slot(
    self, oracle_id: str
) -> Optional[DataAndSlot[OraclePriceData]]:
    """
    获取Oracle价格数据（Oracle专用接口，类似Rust SDK的get_by_market）
    - 使用oracle_id作为参数（类似Rust SDK的MarketId）
    - oracle_id格式：'pubkey-source_num'（字符串，不是索引）
    """
    # ✅ 直接使用 oracle_id（类似 Rust SDK 使用 MarketId）
    return self.oracle_subscriber.get_data(oracle_id)
```

**说明**：
- `oracle_id` 是字符串格式 `"pubkey-source_num"`，不是索引数字
- 不会有歧义，因为包含完整的 pubkey 和 source_num

### 3. 市场索引接口（已存在）

**用途**：
- 通过市场索引获取 oracle 数据

**签名**：
```python
def get_oracle_price_data_and_slot_for_perp_market(
    self, market_index: int
) -> Optional[DataAndSlot[OraclePriceData]]:
    """通过 perp 市场索引获取 oracle 数据"""
    oracle_id = self.perp_market_oracle_strings_map.get(market_index)
    if oracle_id:
        return self.get_oracle_price_data_and_slot(oracle_id)
    return None

def get_oracle_price_data_and_slot_for_spot_market(
    self, market_index: int
) -> Optional[DataAndSlot[OraclePriceData]]:
    """通过 spot 市场索引获取 oracle 数据"""
    oracle_id = self.spot_market_oracle_strings_map.get(market_index)
    if oracle_id:
        return self.get_oracle_price_data_and_slot(oracle_id)
    return None
```

**说明**：
- 这些接口接受 `market_index: int`（数字）
- 内部转换为 `oracle_id: str`（字符串）
- **不会有歧义**，因为参数类型不同

---

## 总结

### 问题1：`get_data(pubkey)` 在 Rust SDK 中有吗？

**答案**：**没有**
- Rust SDK 只有 `get_by_market(market: MarketId)`
- `get_data(pubkey)` 是 Python SDK 的通用接口，用于非 oracle 账户（向后兼容）

### 问题2：`get_data(oracle_id)` 中的 `oracle_id` 是什么？

**答案**：`oracle_id` 是字符串格式 `"pubkey-source_num"`，**不是索引数字**

**格式**：`"5r8RWTaRiMgr9Lph3FTUE3sGb1vymhpCrm83Bovjfcps-1"`

**为什么不会有歧义**：
1. 包含完整的 pubkey（44 个字符）
2. 包含 source_num（区分不同的 oracle source）
3. 字符串格式，不会与市场索引混淆
4. 接口参数类型不同（`str` vs `int`）

**示例**：
```python
# ✅ 使用 oracle_id（字符串）
oracle_id = "5r8RWTaRiMgr9Lph3FTUE3sGb1vymhpCrm83Bovjfcps-1"
data = client.get_oracle_price_data_and_slot(oracle_id)

# ✅ 使用市场索引（数字）
data = client.get_oracle_price_data_and_slot_for_perp_market(75)  # perp 市场索引 75
data = client.get_oracle_price_data_and_slot_for_spot_market(5)   # spot 市场索引 5

# ❌ 不会混淆，因为参数类型不同
```
